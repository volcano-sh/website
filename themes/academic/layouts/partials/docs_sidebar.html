{{ $current_page := . }}
{{ $menu_name := (path.Base (path.Split .Path).Dir) }}
{{ with (index .Site.Menus $menu_name) }}
{{ else }}
{{ errorf "Please define menu items named `[menu.%s]` in your %s front matter or define `[[menu.%s]]` in `config.toml`." $menu_name .Path $menu_name }}
{{ end }}

<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  {{ if eq $.Site.Params.search.engine 1 }}
  <input name="q" type="search" class="form-control" id="search-query" placeholder="{{ i18n "search_placeholder" }}" autocomplete="off">
  {{ end }}
</form>

<nav class="collapse docs-links" id="docs-nav">
  {{ with (index .Site.Menus $menu_name) }}
  {{ range (index $.Site.Menus $menu_name).ByWeight }}
  <div class="docs-toc-item{{ if $current_page.IsMenuCurrent $menu_name . }} active{{ end }}">
    <a class="docs-toc-link" {{ if .URL }}href="{{ .URL }}"{{else if .HasChildren }}href="{{(index .Children 0).URL }}"{{end}} style="width: 77%;float: left;padding-right: 0px;">{{ .Name }}</a>
    <div style="width: 80px;height: 43px;position: relative;left: calc( 100% - 80px );">
      <div style="width: 0px;height: 0px;border:5px solid #fff;border-top-color:rgba(0, 0, 0, .65);position: relative;top: 18px;left: calc(50% - 0px);" onclick="toggleMenu('{{.Weight}}', '{{.Name}}')" class="change_dot" id="dot-{{.Name}}"></div>
    </div>
    {{- if .HasChildren }}
    <ul class="nav docs-sidenav box" style="display: block;" id="menu-{{.Weight}}">
      {{ $parentIdentifier := .Identifier }}
      {{ range .Children }}
      <li {{ if $current_page.IsMenuCurrent $menu_name . }}class="active"{{ end }} style="padding-left: 15px;">
        {{- if .HasChildren }}
          {{/* Second-level item with children (e.g., Plugins) */}}
          <a href="javascript:void(0);" onclick="toggleSubmenu('{{.Identifier}}')" style="display: flex; align-items: center; justify-content: space-between;">
            <span>{{ .Name }}</span>
            <div style="width: 0px;height: 0px;border:5px solid #fff;border-top-color:rgba(0, 0, 0, .65);margin-left: 5px;" class="change_dot submenu-arrow" id="dot-{{.Identifier}}"></div>
          </a>
          {{/* Third-level submenu (individual plugins) */}}
          <ul class="nav docs-sidenav-nested box" style="display: none;" id="submenu-{{.Identifier}}">
            {{ range .Children }}
            <li {{ if $current_page.IsMenuCurrent $menu_name . }}class="active"{{ end }} style="padding-left: 30px;">
              <a href="{{ .URL }}">{{ .Name }}</a>
            </li>
            {{ end }}
          </ul>
        {{- else }}
          {{/* Regular second-level item without children */}}
          <a href="{{ .URL }}">{{ .Name }}</a>
        {{- end }}
      </li>
      {{ end }}
    </ul>
    {{ end }}

  </div>
  {{ end }}
  {{ end }}
</nav>

<script type="text/javascript">
  // Toggle top-level menus
  function toggleMenu(weight, name) {
    var menu = document.getElementById('menu-' + weight);
    var dot = document.getElementById('dot-' + name);
    
    if (menu && dot) {
      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        dot.style.borderTopColor = 'rgba(0, 0, 0, .65)';
        dot.style.borderRightColor = '#fff';
        dot.style.left = 'calc(50% - 0px)';
      } else {
        menu.style.display = 'none';
        dot.style.borderRightColor = 'rgba(0, 0, 0, .65)';
        dot.style.borderTopColor = '#fff';
        dot.style.left = 'calc(50% - 2px)';
      }
    }
  }
  
  // Toggle second-level submenus (Plugins)
  function toggleSubmenu(identifier) {
    var submenu = document.getElementById('submenu-' + identifier);
    var dot = document.getElementById('dot-' + identifier);
    
    if (submenu && dot) {
      if (submenu.style.display === 'none') {
        submenu.style.display = 'block';
        dot.style.borderTopColor = 'rgba(0, 0, 0, .65)';
        dot.style.borderRightColor = '#fff';
        dot.style.transform = 'rotate(0deg)';
      } else {
        submenu.style.display = 'none';
        dot.style.borderRightColor = 'rgba(0, 0, 0, .65)';
        dot.style.borderTopColor = '#fff';
        dot.style.transform = 'rotate(-90deg)';
      }
    }
  }
  
  // Auto-expand + scroll position
  document.addEventListener('DOMContentLoaded', function() {
    var sidebar = document.getElementById('docs-nav');
    if (!sidebar) return;
    
    // Auto-expand active menus
    var activeItems = document.querySelectorAll('.docs-sidenav li.active');
    activeItems.forEach(function(item) {
      var parentSubmenu = item.closest('.docs-sidenav-nested');
      if (parentSubmenu) {
        parentSubmenu.style.display = 'block';
        var submenuId = parentSubmenu.id.replace('submenu-', '');
        var submenuDot = document.getElementById('dot-' + submenuId);
        if (submenuDot) {
          submenuDot.style.borderTopColor = 'rgba(0, 0, 0, .65)';
          submenuDot.style.borderRightColor = '#fff';
        }
      }
      
      var parentMenu = item.closest('.box');
      if (parentMenu && parentMenu.id.startsWith('menu-')) {
        parentMenu.style.display = 'block';
      }
    });
    
    // Restore scroll position
    var savedScrollPos = sessionStorage.getItem('docs-sidebar-scroll');
    if (savedScrollPos) {
      sidebar.scrollTop = parseInt(savedScrollPos, 10);
    }
    
    // Save scroll on navigation
    window.addEventListener('beforeunload', function() {
      sessionStorage.setItem('docs-sidebar-scroll', sidebar.scrollTop);
    });
    
    var sidebarLinks = sidebar.querySelectorAll('a');
    sidebarLinks.forEach(function(link) {
      link.addEventListener('click', function() {
        sessionStorage.setItem('docs-sidebar-scroll', sidebar.scrollTop);
      });
    });
  });

  function change(aaa) {  // Bug fix: removed unused parameter
    var ull = document.getElementsByClassName('box');
    var dots = document.getElementsByClassName('change_dot');
    
    for (var i = 0; i < ull.length; i++) {
      if (ull[i].style.display == 'block' && ull[i].id == aaa) {
        ull[i].style.display = 'none';
        dots[i].style.borderRightColor='rgba(0, 0, 0, .65)';
        dots[i].style.borderTopColor='#fff';
        dots[i].style.left='calc(50% - 2px)';
      } else if(ull[i].style.display == 'none' && ull[i].id == aaa){
        ull[i].style.display = 'block';
        dots[i].style.borderTopColor='rgba(0, 0, 0, .65)';
        dots[i].style.borderRightColor='#fff';
        dots[i].style.left='calc(50% - 0px)';
      }
    }
  }
</script>

<style>
.docs-sidenav-nested {
  list-style: none;
  padding-left: 0;
}

.docs-sidenav-nested li a {
  display: block;
  padding: 0.25rem 0;
  text-decoration: none;
}

.docs-sidenav-nested li a:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.docs-sidenav-nested li.active > a {
  font-weight: bold;
  color: #d32f2f;
}

.submenu-arrow {
  transition: transform 0.2s ease;
}
</style>